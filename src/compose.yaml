services:
  
  ### Common Service ###
  messageBroker:
    image: rabbitmq:management
    container_name: messageBroker_rabbitmq
    hostname: ecommerce-rabbitmq-server
    networks:
      - messageBroker_network
  
  # Mailpit - SMTP de développement pour capturer les emails
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # WebUI
    networks:
      - email_network
    restart: unless-stopped
  
  ### Service Catalog ###
  
  catalog.database:
    image: postgres:latest
    container_name: catalog_database
    networks:
      - catalog_network
  
  catalog.api:
    image: catalog.api
    container_name: catalog_api
    build:
      context: .
      dockerfile: eshop.services/catalog/Catalog.API/Dockerfile
    networks:
      - catalog_network
    depends_on:
      catalog.database:
        condition: service_healthy
        required: true
        restart: true
  
  
  ### Service Discount ###
  
  discount.grpc:
    image: discount.grpc
    container_name: discount_grpc
    restart: always
    build:
      context: .
      dockerfile: eshop.services/discount/Discount.Grpc/Dockerfile
    networks:
      - discount_network
      - basket_network
  
  ### Service Basket ###
  
  basket.database:
    image: postgres:latest
    container_name: basket_database
    networks:
      - basket_network
  
  basket.redis:
    image: redis:latest
    container_name: basket_redis
    networks:
      - basket_network

  basket.api:
    image: basket.api
    container_name: basket_api
    build:
      context: .
      dockerfile: eshop.services/basket/Basket.API/Dockerfile
    networks:
      - basket_network
      - messageBroker_network
    depends_on:
      basket.database:
        condition: service_healthy
        required: true
        restart: true
      basket.redis:
        condition: service_healthy
        required: true
        restart: true
      messageBroker:
        condition: service_healthy
        required: true
        restart: true
      discount.grpc:
        condition: service_started
        required: true
        restart: true
  
  ### Service Ordering ###

  ordering.database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ordering_database
    platform: linux/amd64
    networks:
      - ordering_network
  
  ordering.api:
    image: ordering.api
    container_name: ordering_api
    build:
      context: .
      dockerfile: eshop.services/ordering/Ordering.API/Dockerfile
    networks:
      - ordering_network
      - messageBroker_network
    depends_on:
      ordering.database:
        condition: service_started
        required: true
        restart: true
      messageBroker:
        condition: service_healthy
        required: true
        restart: true
        
  ### API Gateway ###    
  
  yarpapigateway:
    image: yarpapigateway
    container_name: yarpapigateway
    build:
      context: .
      dockerfile: eshop.gateway/YarpApiGateway/Dockerfile
    networks:
      - ordering_network
      - basket_network
      - catalog_network
    depends_on:
      ordering.api:
        condition: service_started
        required: true
        restart: true
      basket.api:
        condition: service_started
        required: true
        restart: true
      catalog.api:
        condition: service_started
        required: true
        restart: true

  ### Service Email ###
  
  email.api:
    image: email.api
    container_name: email_api
    build:
      context: .
      dockerfile: eshop.services/email/Email.API/Dockerfile
    ports:
      - "6070:8080"
      - "6071:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=${ASPNETCORE_URLS}
      - SmtpSettings__Server=${SMTP_SERVER}
      - SmtpSettings__Port=${SMTP_PORT}
      - SmtpSettings__Username=${SMTP_USERNAME}
      - SmtpSettings__Password=${SMTP_PASSWORD}
      - SmtpSettings__EnableSsl=${SMTP_ENABLE_SSL}
      - SmtpSettings__FromEmail=${SMTP_FROM_EMAIL}
      - SmtpSettings__FromName=${SMTP_FROM_NAME}
      - MessageBroker__Host=${RABBITMQ_HOST}
      - MessageBroker__UserName=${RABBITMQ_USERNAME}
      - MessageBroker__Password=${RABBITMQ_PASSWORD}
    networks:
      - email_network
      - messageBroker_network
    depends_on:
      messageBroker:
        condition: service_healthy
        required: true
        restart: true
      mailpit:
        condition: service_started
        required: true
        restart: true
    restart: unless-stopped

### Shared infrastructure ###
volumes:
  catalog_data:
    name: catalog_data
  basket_data:
    name: basket_data
  ordering_data:
    name: ordering_data
  redis_data:
    name: redis_data
  messageBroker_data:
    name: messageBroker_data
  messageBroker_logs:
    name: messageBroker_logs


networks:
  catalog_network:
    name: catalog_network
  basket_network:
    name: basket_network
  discount_network:
    name: discount_network
  ordering_network:
    name: ordering_network
  messageBroker_network:
    name: messageBroker_network
  email_network:
    name: email_network